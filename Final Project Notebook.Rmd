---
title: "Final Project Notebook"
authors: "Brian Bacik, Chiu Feng Yap, Joy Yoo, Yi Yao, Yun Qing"
date: "3/26/2021"
output: html_document
---


### Introduction of the Project
The goal of this project is to predict in-hospital ‘death’ of Subarachnoid Hemorrhage (SAH) patients using all patients’ records in the first 3 days from the start time of the hospitalization. No information after the first 3 days should be used as variables. Inputs of prediction includes patients’ encounter data, medications, and procedures.  A test set will be given but the outcome will not be included in the dataset provided to students. 

### Outcome
The primary outcome is mortality; defined as in-hospital death or discharge to hospice care. 

### Task 
Build a machine-learning model to predict mortality in subarachnoid hemorrhage patients. 


####  Importing datasets 

```{r message=FALSE}
### loading packages
library(dplyr)
library(readr)
library(tidyr)
library(lubridate)
library(ggplot2)
library(anytime)
library(compareGroups)
library(tidyverse)
library(janitor)
```

```{r message=FALSE}
demo_train <- read_csv("demo_train.csv")
med_train <- read_csv("medication_train.csv")
proc_train <- read_csv("procedure_train.csv")
```

#### Factor-to-time conversion

```{r}
demo_train <- demo_train %>% 
  mutate(New_admitted_dt_tm = anytime(New_admitted_dt_tm), ## anytime() Parse POSIXct or Date objects from input data
         New_discharge_dt_tm = anytime(New_discharge_dt_tm))
# demo_te <- demo_te %>% 
#   mutate(New_admitted_dt_tm = anytime(New_admitted_dt_tm), 
#          New_discharge_dt_tm = anytime(New_discharge_dt_tm), 
#          los = difftime(New_discharge_dt_tm, New_admitted_dt_tm, 
#                         units = "days")
#          )

med_train$med_started_dt_tm <- anytime(med_train$med_started_dt_tm)
# med_te$med_started_dt_tm <- anytime(med_te$med_started_dt_tm)

proc_train$procedure_dt_tm <- anytime(proc_train$procedure_dt_tm)
# proc_te$procedure_dt_tm <- anytime(proc_te$procedure_dt_tm)

```


#### Renaming columns 
```{r}
demo_train <- demo_train %>% 
  rename(
    patient_num = patient_sk,
    age = age_in_years,
    admission_date = New_admitted_dt_tm,
    discharge_date = New_discharge_dt_tm
  )

med_train <- med_train %>% 
  rename(
    patient_num = patient_sk,
    medication_date = med_started_dt_tm
  )

proc_train <- proc_train %>% 
  rename(
    patient_num = patient_sk,
    procedure_date = procedure_dt_tm
  )
```



#### To combine all prediction variables into one dataset, we first:

    - add patient's admission date to the med_train & proc_train data, then calculate the day difference (X)
    - remove rows from both dataframes that have more than 3 days
    - convert medication and procedure data from long to wide format. 
    - add outcome variable death to each of the medication and procedure data.
    - apply dimension reduction methods (variable selection, PCA) medication and procedure data (Supervised or unsupervised)?
    - combine all the information into the main demo_train dataset that contains patients' demographics
    - calculate length of stay (LOS) and select only those patients have more than or equal to 3 day of LOS. 

```{r}
med_train <- demo_train %>% 
  select(patient_num, admission_date) %>% 
  right_join(med_train, by = "patient_num")
```
```{r}
proc_train <- demo_train %>% 
  select(patient_num, admission_date) %>% 
  right_join(proc_train, by = "patient_num")
```


#### Rearranging columns order
```{r}
# colnames(med_train)
med_train <- med_train[,c(1,3,2,4)]

# colnames(proc_train)
proc_train <- proc_train[,c(1,3,4,2,5)]
```



#### Calculating the date intervals in days

- define LOS = discharge_date - admission_date

```{r}
demo_train <- demo_train %>% 
  mutate(
    los = as.numeric(difftime(discharge_date, admission_date, units ="days"))
  )
```

```{r}
med_train <- med_train %>% 
  mutate(
    days_med_adm = as.numeric(difftime(medication_date, admission_date, units ="days"))
  )
```

```{r}
proc_train <- proc_train %>% 
  mutate(
    days_pro_adm = as.numeric(difftime(procedure_date, admission_date, units ="days"))
  )
```





#### Checking Missingness

    No missing data in all three training datasets. 
    
```{r}
demo_train[!complete.cases(demo_train),]  ## no missing data
```
```{r}
proc_train[!complete.cases(proc_train),] ## no missing data
```
```{r}
med_train[!complete.cases(med_train),] # no missing data
```


####  Data Visualization 

* Age 

```{r}
ggplot(data = demo_train) + geom_histogram(mapping=aes(x=age), binwidth=0.5)
```

* Race by Death

```{r}
ggplot(demo_train, aes(x = death, fill = race)) +
  geom_bar() + 
  scale_fill_viridis_d()
```




#### Descriptive of demographic training data

```{r}
demo_train$death <- as.factor(demo_train$death)
cg <- compareGroups(death ~ gender+race+age+los, 
                    data = demo_train, 
                    method = c(3,3,1,2), 
                    max.xlev = 12, 
                    Q1 = 0, Q3 = 1)
createTable(cg, show.n = F, show.p.overall = T)
```

    - delete the one observation that has unknown gender in demo train
    
    - race has too many categories, need to combine some of them. 
    
      + Combine the minority groups Asian, Pacific Islander, Asian/Pacific Islander, Biracial, Hispanic, Mid Eastern Indian, Native American, and Other to a new category, Others. 
      
      + We may want to keep the Unknown category in race. (Are Unknowns missing values?) //Steph: good question, I would think yes, they are missing values. 
      
    - delete those patients discharged within first 3 days (los < 3)
    
     + 786 patients were deleted. 
  
```{r}
demo_train_new <- demo_train %>% filter(gender != "Unknown") %>%
  mutate(race = fct_recode(race, 
                           `Others` = 'Asian', 
                           `Others` = 'Pacific Islander', 
                           `Others` = 'Asian/Pacific Islander', 
                           `Others` = 'Biracial', 
                           `Others` = 'Hispanic', 
                           `Others` = 'Mid Eastern Indian', 
                           `Others` = 'Native American', 
                           `Others` = 'Other')) %>%
  filter(los >= 3)
  
```
 
 
#### Descriptive analysis for new demographic training data: 
```{r}
cg.new <- compareGroups(death ~ gender+race+age+los, 
                    data = demo_train_new, 
                    method = c(3,3,1,2), 
                    Q1 = 0, Q3 = 1)
createTable(cg.new, show.n = F, show.p.overall = T)
```


```{r}
# library(mice)
# demo.tmp2
# demo.imputed <- mice(demo.tmp2, method = "polyreg", seed = 123, 
#                      printFlag = F, 
#                      formulas = list(race ~ age + gender))
```

```{r}
# There are 5 imputed data, select only of them for descriptive analysis.
# demo_imputed <- complete(demo.imputed, 1) 
# cg.new2 <- compareGroups(death ~ gender+race+age+los, 
#                     data = demo_imputed, 
#                     method = c(3,3,1,2), 
#                     Q1 = 0, Q3 = 1)
# createTable(cg.new2, show.n = F, show.p.overall = T)
```

Deleting Unknowns in race variable since the missingness is <10%. 

```{r}
demo.tmp <- demo_train_new %>% filter(race != "Unknown")
cg.new <- compareGroups(death ~ gender+race+age+los, 
                    data = demo.tmp, 
                    method = c(3,3,1,2), 
                    Q1 = 0, Q3 = 1)
createTable(cg.new, show.n = F, show.p.overall = T)
```


* Plot of LOS
```{r}
demo_train_new<- demo_train_new %>% filter(race != "Unknown")
```

```{r}
ggplot(demo_train_new, aes(los, fill = death)) + 
  geom_histogram(alpha = 0.5, binwidth = 10) + 
  theme_bw()
```

##### Descriptives of medication training data

New variables' definition/Codebook:
    
    n_med: number of medications per patient.
    
    min_time_from_admit, max_time_from_admit: minimal/maximum time of medication administration after admission to hospital for each patient. 
    
    any_vaso: Did this patient receive at least 1 vassopressor (dopamin, phenylephrine, norepinephrine)?
    
    n_vaso: Number of vassopressors the patient took. 
    
```{r message=FALSE}
med.tmp1 <- med_train %>% group_by(patient_num) %>%
  summarise(n_med = n(),
            min_days_med_adm = min(days_med_adm),
            max_days_med_adm = max(days_med_adm),
            any_vaso = any(generic_name %in% c("dopamine", "phenylephrine",  "norepinephrine")),
            n_vaso = sum(generic_name %in% c("dopamine", "phenylephrine",  "norepinephrine"))) %>% 
  ungroup()
```


```{r}
cg2 <- compareGroups(~ n_med + n_med + min_days_med_adm + max_days_med_adm + any_vaso + n_vaso, 
                     data = med.tmp1, 
                     method = c(1,2,2,2,3,2), Q1 = 0, Q3 = 1)
createTable(cg2, show.n = F)
```

    The number of medications administered to a patient averages at 26 (median = 23) and ranges from 1 to 182. The majority of medications were administered within one day of admission to the hospital. About 18.1% of patient received at lease one vassopressor. 

#### Descriptive analysis grouped by any_vaso:

```{r}
med.tmp1$any_vaso <- as.factor(med.tmp1$any_vaso)
cg3 <- compareGroups(any_vaso ~ n_med + min_days_med_adm + max_days_med_adm + n_vaso , 
                     data = med.tmp1, 
                     method = c(1,2,2,2,2,1,2), Q1 = 0, Q3 = 1)
createTable(cg3, show.n = F)
```

    The table above shows that patients who have at least taken one vasopressors tend to have taken higher number of medications and larger range of medication administration time. 

```{r message=FALSE}
med_freq <- med_train %>% group_by(generic_name) %>%
  summarise(n = n()) %>%
  arrange(desc(n)) 

med_freq
```

DOUBLE CHECK:: We are planning to create dummy variables for each medication that had been prescribed to at least 500 patients in the dataset.

#### Viewing the most used procedures in propotions 

```{r}
janitor::tabyl(med_train, generic_name) %>% arrange(desc(n)) %>% top_n(20)
```


#### Descriptives analysis for procedure training data

```{r}
proc.tmp1 <- proc_train %>% group_by(patient_num) %>% 
  summarise(n_proc = n(), 
            min_days_pro_adm = min(days_pro_adm),
            max_days_pro_adm = max(days_pro_adm)) 

proc.tmp1
```


```{r}
cg3 <- compareGroups(~ n_proc + n_proc + min_days_pro_adm + max_days_pro_adm, 
                     data = proc.tmp1, 
                     method = c(1,2,2,2), 
                     Q1 = 0, Q3 = 1)
createTable(cg3, show.n = F)
```



#### View frequently used procedured by procedure_id:

    There's a total of 1254 procedures. The top 3 most used procedure is arteriography of cerebral arteries, minsertion of endotracheal tube followed by continuous invasive mechanical ventilation for less than 96 consecutive hours.

```{r}
proc_freq <- proc_train %>% group_by(procedure_id) %>%
  summarise(n = n(), 
            procedure_description = first(procedure_description)) %>%
  arrange(desc(n)) 

proc_freq
```


#### Viewing the most used procedures in propotions 
```{r}
janitor::tabyl(proc_train, procedure_id) %>% arrange(desc(n)) %>% top_n(20)
```

Are any of the procedures predictive of death?
```{r}

```


#### Combining all dataframes into one by id and admission date (WHEN THE SMALLER DATASETS ARE CLEANED)
```{r}
joined_df <- demo_train_new %>%
  left_join(med.tmp1, by = c('patient_num')) %>%
  left_join(proc.tmp1, by = c('patient_num'))
```

#### Predictive Model Approaches 

1. Basic logistic regression 
```{r}
logit <- glm(death ~ gender + race + age + los + n_med + min_days_med_adm + max_days_med_adm + any_vaso + n_vaso + n_proc + min_days_pro_adm + max_days_pro_adm, data = , family = "binomial")

summary(logit)
```

```{r}
coef(logit)
```

```{r}
summary(logit)$coef
```

