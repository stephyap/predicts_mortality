---
title: "Final Project Notebook"
authors: "Brian Bacik, Chiu Feng Yap, Joy Yoo, Yi Yao, Yun Qing"
date: "3/26/2021"
output: html_document
---


### Introduction of the Project
The goal of this project is to predict in-hospital ‘death’ of Subarachnoid Hemorrhage (SAH) patients using all patients’ records in the first 3 days from the start time of the hospitalization. No information after the first 3 days should be used as variables. Inputs of prediction includes patients’ encounter data, medications, and procedures.  A test set will be given but the outcome will not be included in the dataset provided to students. 

### Outcome
The primary outcome is mortality; defined as in-hospital death or discharge to hospice care. 

### Task 
Build a machine-learning model to predict mortality in subarachnoid hemorrhage patients. 


####  Importing datasets 

```{r message=FALSE}
### loading packages
library(dplyr)
library(readr)
library(tidyr)
library(lubridate)
library(ggplot2)
```

```{r}
library(readr)
demo_train <- read_csv("demo_train.csv")

medication_train <- read_csv("medication_train.csv")

procedure_train <- read_csv("procedure_train.csv")

```

#### Viewing top 5 rows for each datasets
```{r}
# head(demo_train, n=5)
```

```{r}
# head(medication_train, n=5)
```

```{r}
# head(procedure_train, n=5)
```
#### Renaming columns 
```{r}
demo_train <- demo_train %>% 
  rename(
    patient_num = patient_sk,
    age = age_in_years,
    admission_date = New_admitted_dt_tm,
    discharge_date = New_discharge_dt_tm
  )

medication_train <- medication_train %>% 
  rename(
    patient_num = patient_sk,
    medication_date = med_started_dt_tm
  )

procedure_train <- procedure_train %>% 
  rename(
    patient_num = patient_sk,
    procedure_date = procedure_dt_tm
  )
```




#### To combine all prediction variables into one dataset, we first:

- add patient's admission date to the medication_train & procedure_train data, then calculate the day difference
- remove rows from both dataframes that have more than 3 days
- combine all the information into the main demo_train dataset that contains patients' demographics

```{r}
medication_train <- demo_train %>% 
  select(patient_num, admission_date) %>% 
  right_join(medication_train)
```
```{r}
procedure_train <- demo_train %>% 
  select(patient_num, admission_date) %>% 
  right_join(procedure_train)
```



#### Rearranging columns order
```{r}
# colnames(medication_train)
medication_train <- medication_train[,c(1,3,2,4)]

# colnames(procedure_train)
procedure_train <- procedure_train[,c(1,3,4,2,5)]
```



#### Calculating the date intervals in days

```{r}
demo_train <- demo_train %>% 
  mutate(
    days_dis_adm = as.numeric(difftime(discharge_date, admission_date, units ="days"))
  )
```

```{r}
medication_train <- medication_train %>% 
  mutate(
    days_med_adm = as.numeric(difftime(medication_date, admission_date, units ="days"))
  )
```

```{r}
procedure_train <- procedure_train %>% 
  mutate(
    days_pro_adm = as.numeric(difftime(procedure_date, admission_date, units ="days"))
  )
```

#### Missing Data 

```{r}
demo_train[!complete.cases(demo_train),]  ## no missing data
```
```{r}
procedure_train[!complete.cases(procedure_train),] ## no missing data
```
```{r}
medication_train[!complete.cases(medication_train),] # no missing data
```


#### Descriptive Analysis

* Age 

```{r}
ggplot(data = demo_train) + geom_histogram(mapping=aes(x=age), binwidth=0.5)
```

* Race

```{r}
ggplot(demo_train, aes(x = death, fill = race)) +
  geom_bar() + 
  scale_fill_viridis_d()
```

1. Deaths 

```{r}
demo_train %>% 
  group_by(death) %>% 
  summarize(Frequency = n()) %>% 
  mutate(Relative_Percentage = (Frequency / sum(Frequency))*100)
```

2. Gender
```{r}
demo_train %>% 
  group_by(gender) %>% 
  summarize(Frequency = n()) %>% 
  mutate(Relative_Percentage = (Frequency / sum(Frequency))*100)
```
3. Race
```{r}
demo_train %>% 
  group_by(race) %>% 
  summarize(Frequency = n()) %>% 
  mutate(Relative_Percentage = (Frequency / sum(Frequency))*100)
```

4. Age
```{r}
summary(demo_train$age)
```

5. Number of days since admission (discharge - admission)
```{r}
gmodels::CrossTable(demo_train$)
```










#### Combining all dataframes into one by id and admission date (WHEN THE SMALLER DATASETS ARE CLEANED)
```{r}
# joined_df <- demo_train %>% 
#   left_join(medication_train, by = c('patient_num', 'admission_date')) %>% 
#   left_join(procedure_train, by = c('patient_num', 'admission_date')) %>% 
#   select(-procedure_description)
```

